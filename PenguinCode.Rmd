---
title: "Homework Template"
output:
  html_document: default
  pdf_document: default
date: "2023-10-09"
---

```{r setup}
renv::restore()
#Installs all required packages
#If renv::restore is not working, please run the activate.R file under the renv folder
#renv seems to have issues with installing base R packages, please use posit cloud if issues persist
```

```{r setup, message = F, warning = F}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tinytex)
library(dplyr)
library(janitor)
library(ggplot2)
library(here)
library(palmerpenguins)
library(ragg)
library(broom)
library(svglite)
library(patchwork)

here::here()
source(here("functions", "cleaning.R"))
source(here("functions", "plotting.R"))

```

*The following is a template .rmd RMarkdown file for you to use for your homework submission.*

*Please Knit your .rmd to a PDF format or HTML and submit that with no identifiers like your name.*

*To create a PDF, first install tinytex and load the package. Then press the Knit arrow and select "Knit to PDF".*

## QUESTION 01: Data Visualisation for Science Communication

*Create a figure using the Palmer Penguin dataset that is correct but badly communicates the data. **Do not make a boxplot**.*

*Use the following references to guide you:*

-   [*https://www.nature.com/articles/533452a*](https://www.nature.com/articles/533452a){.uri}
-   [*https://elifesciences.org/articles/16800*](https://elifesciences.org/articles/16800){.uri}

*Note: Focus on visual elements rather than writing misleading text on it.*

### a) Provide your figure here:

```{r bad figure code, echo=FALSE}
#Loading the data (note: previous steps have been taken to ensure a clean csv)
penguins_clean <- read.csv(here("data", "penguins_clean.csv"))

bad_means <- aggregate(flipper_length_mm ~ species, data = penguins_clean, FUN = mean)

badplot <- ggplot(
  data = bad_means, 
  aes(x = species, 
      y = flipper_length_mm)) +
  geom_point()
badplot

# There is no need to provide the code for your bad figure, just use echo=FALSE so the code is hidden. Make sure your figure is visible after you knit it. 

```

### b) Write about how your design choices mislead the reader about the underlying data (200-300 words).

*There are three overarching mistakes made with the design choices for the above chart:*

-   Wrong chart type selection: A scatter plot is used, despite the fact that x-axis is categorical (species). Therefore the distance between dots does not show any useful information, and confuse the reader. Instead, a bar chart would be more appropriate.
-   Oversimplified data: By averaging the flipper lengths, the information shown is reduced to just a single point and therefore the variation, SD etc are all missing. Furthermore, the single dot does not convey the meaning of the data well, as a reader would struggle to realise that it represents the mean length. To correct this, a change in chart type as well as clear labeling is needed.
-   Truncated y-axis: The y-axis begins from 190, exaggerating the difference in flipper lengths between the different species. This misdirects the reader, as the actual difference between chinstrap and gentoo flipper length is 5% but the difference between dots is visually represented as being 200%.

*Sources:*

-   Sturge, Georgina. Bad Data. 3 Nov. 2022.

-   Keller, H., and Ch Trendelenburg. Data Presentation / Interpretation. Berlin, De Gruyter, 2019.

    ------------------------------------------------------------------------

## QUESTION 2: Data Pipeline

*Write a data analysis pipeline in your .rmd RMarkdown file. You should be aiming to write a clear explanation of the steps, the figures visible, as well as clear code.*

*Your code should include the steps practiced in the lab session:*

-   *Load the data*

-   *Appropriately clean the data*

-   *Create an Exploratory Figure (**not a boxplot**)*

-   *Save the figure*

-   ***New**: Run a statistical test*

-   ***New**: Create a Results Figure*

-   *Save the figure*

*An exploratory figure shows raw data, such as the distribution of the data. A results figure demonstrates the stats method chosen, and includes the results of the stats test.*

*Between your code, communicate clearly what you are doing and why.*

*Your text should include:*

-   *Introduction*

-   *Hypothesis*

-   *Stats Method*

-   *Results*

-   *Discussion*

-   *Conclusion*

*You will be marked on the following:*

### a) Your code for readability and functionality

### b) Your figures for communication

### c) Your text communication of your analysis

*Below is a template you can use.*

------------------------------------------------------------------------

### Introduction

The palmerpenguins dataset contains information about 3 species of penguins: Adelie, Gentoo and Chinstrap. Before we can begin using this data, we must load the raw data and clean it using the functions in our cleaning.R file. Next, an exploratory figure of the penguin's culmen (beak) length and depth is generated using the *plot_scatter* function located in plotting.R. This figure is saved to svg format using the *save_plot_svg* function, also located in plotting.R.

```{r Data Cleaning}
# All packages/functions have been loaded in the R setup chunk at the start of this file using renv
# Save the raw data to csv as a read only back-up:
write.csv(penguins_raw, here("data", "penguins_raw.csv"))

# Load the raw data and clean it 
penguins_raw <- read_csv(here("data", "penguins_raw.csv"))
penguins_clean <- penguins_raw %>%
  clean_column_names() %>%
  remove_columns(c("comments", "delta")) %>%
  shorten_species() %>%
  remove_empty_columns_rows()

#Ensure output is clean
names(penguins_clean)

#Save the cleaned data
write_csv(penguins_clean, here("data", "penguins_clean.csv"))

#Subset the data of interest
culmen_data <- penguins_clean %>%
  select(culmen_length_mm, culmen_depth_mm, species) %>%
  drop_na()

#Show this data subset
head(culmen_data)
```

```{r Exploratory Figure}
#Exploratory figure 
species_colours <- c("Adelie" = "darkorange", 
                    "Chinstrap" = "purple", 
                    "Gentoo" = "cyan4")

exploratory_fig <- plot_scatter(culmen_data, culmen_length_mm, culmen_depth_mm,"Culmen Length (mm)", "Culmen Depth (mm)", species, species_colours )

exploratory_fig
```

From the plot above, we can see that there does not seem to be an overall relationship between length and depth. Interestingly, however, we can observe that within different species, there appears to be a positive correlation between culmen length and depth. Therefore, there are two tests we can carry out: one looking for a correlation at the multi-species level and one looking for a relationship within species.

```{r Saving the Figure}
#Saving the figure
save_plot_svg(exploratory_fig, here("figures", "Exploratory_Figure.svg"), 90,60, 3.5)
```

### Hypothesis

First Null Hypothesis: There is no overall correlation between culmen length and depth across penguin species.

First Alternative Hypothesis: There is an overall correlation between culmen length and depth across penguin species.

Second Null Hypothesis: There is no correlation between culmen length and depth within penguin species.

Second Alternative Hypothesis: There is a correlation between culmen length and depth within penguin species.

### Statistical Methods

Two sets of linear regression between culmen length and depth are carried out, one for the entire penguins dataset, and one for each individual species. This results in four total regressions.

Firstly, the linear regression for all pengion species is calculated

```{r Statistics}
#Runs a linear regression for all of the penguins
all_penguin_model <- lm(culmen_depth_mm ~ culmen_length_mm, data = culmen_data)
summary(all_penguin_model)
```

As we can see, although there is a slight negative relationship (-0.085), it has a low $R^2$. This will be explored further in the results and discussion. Next, each penguin species is analysed independently.

```{r}
#Runs a linear regression for the adelie penguins
adelie_model <- lm(culmen_depth_mm ~ culmen_length_mm, data = culmen_data %>% 
                          filter(species %in% c("Adelie")))
summary(adelie_model)
```

```{r}
#Runs a linear regression for the chinstrap penguins
chinstrap_model <- lm(culmen_depth_mm ~ culmen_length_mm, data = culmen_data %>% 
                          filter(species %in% c("Chinstrap")))
summary(chinstrap_model)
```

```{r}
#Runs a linear regression for the gentoo penguins
gentoo_model <- lm(culmen_depth_mm ~ culmen_length_mm, data = culmen_data %>% 
                          filter(species %in% c("Gentoo")))
summary(gentoo_model)
```

Individually, the species have a much more significant positive correlation and the $R^2$ is much higher for all species, especially Chinstrap and Gentoo. Before making any further analysis, it is useful to plot these results. 

### Results & Discussion
By plotting the linear regression against the data it will make any relationships clearer. We start by looking at the overall linear regression for all penguin species. 

```{r Plotting Results}
overall_combined_plot <- ggplot(culmen_data,
         aes(x = culmen_length_mm,
             y = culmen_depth_mm,
             color = species)) +
    geom_point(size = 2, alpha = 0.8) +
    geom_smooth(method = "lm", color = "cyan") +
    scale_color_manual(values = species_colours) +
    theme_light() +
    labs(x = "Culmen Length (mm)",
         y = "Culmen Depth (mm)") +
    theme(legend.position = "bottom")

overall_combined_plot
```

This visualization is helpful because it demonstrates the slight negative relationship found by the model. As demonstrated in the statistical test, however, it has a very low $R^2$ value of 0.055. This suggests that although the slight negative correlation is significant, with a p-value < 0.001, Culmen Length does not explain most of the actual variation in Culmen Depth. Rather, the negative relationship is probably a factor of the penguins being different species. For now, the next stage is plotting the same relationship for each penguin species. 

```{r}
#Plotting relationship for Adelie Penguins
adelie_lm <- plot_scatter_lm(culmen_data, culmen_length_mm, culmen_depth_mm,"Culmen Length (mm)", "Culmen Depth (mm)", species, species_colours,"Adelie")

adelie_lm
```

```{r}
#Plotting relationship for Chinstrap Penguins
chinstrap_lm <- plot_scatter_lm(culmen_data, culmen_length_mm, culmen_depth_mm,"Culmen Length (mm)", "Culmen Depth (mm)", species, species_colours,"Chinstrap")

chinstrap_lm
```

```{r}
#Plotting relationship for Gentoo Penguins
gentoo_lm <- plot_scatter_lm(culmen_data, culmen_length_mm, culmen_depth_mm,"Culmen Length (mm)", "Culmen Depth (mm)", species, species_colours,"Gentoo")

gentoo_lm
```

As shown in the figures, each penguin species individually has a positive relationship. The confidence intervals are shown in grey. 

Before saving these plots, we can combine them into a single figure for a more professional diagram. 

```{r Overall Plot}
#Creating an overall results figure
combined_plot <- (overall_combined_plot | adelie_lm) / (chinstrap_lm | gentoo_lm)
combined_plot
```

```{r}
#Saves this overall plot
save_plot_svg(combined_plot, here("figures", "Combined_Plot.svg"), 90,60, 3.5)
```



### Conclusion

------------------------------------------------------------------------

## QUESTION 3: Open Science

### a) GitHub

*Upload your RProject you created for **Question 2** and any files and subfolders used to GitHub. Do not include any identifiers such as your name. Make sure your GitHub repo is public.*

*GitHub link:*

*You will be marked on your repo organisation and readability.*

### b) Share your repo with a partner, download, and try to run their data pipeline.

*Partner's GitHub link:*

*You **must** provide this so I can verify there is no plagiarism between you and your partner.*

### c) Reflect on your experience running their code. (300-500 words)

-   *What elements of your partner's code helped you to understand their data pipeline?*

-   *Did it run? Did you need to fix anything?*

-   *What suggestions would you make for improving their code to make it more understandable or reproducible, and why?*

-   *If you needed to alter your partner's figure using their code, do you think that would be easy or difficult, and why?*

### d) Reflect on your own code based on your experience with your partner's code and their review of yours. (300-500 words)

-   *What improvements did they suggest, and do you agree?*

-   *What did you learn about writing code for other people?*
